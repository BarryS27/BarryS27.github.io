name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
      
      # Using 3.12 for better binary compatibility with libsass
      - name: Set up Python ğŸ
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Cache Dependencies ğŸ“¦
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Dependencies ğŸ”§
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build Static Site ğŸ—ï¸
        run: |
          python freeze.py
      
      - name: Verify Build ğŸ”
        run: |
          if [ ! -f "build/index.html" ]; then
            echo "âŒ Build verification failed: index.html not found"
            exit 1
          fi
          if [ ! -f "build/static/css/styles.css" ]; then
            echo "âŒ Build verification failed: styles.css not found"
            exit 1
          fi
          echo "âœ… Build verification passed"
      
      - name: Deploy to GitHub Pages ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: build
          clean: true
          single-commit: true
